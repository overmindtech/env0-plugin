name: Overmind
icon: https://avatars.githubusercontent.com/u/93521445
inputs:
  action:
    description: The action to perform. Must be one of: submit-plan, start-change, end-change
    required: true
  api_key:
    description: Overmind API key for authentication
    required: true
  tags:
    description: A comma-separated list of key=value tags to attach to the change (only used with submit-plan action)
    required: false
  app:
    description: The Overmind instance to connect to (defaults to https://app.overmind.tech)
    required: false
run:
  exec: |
    #!/bin/sh
    set -e
    
    # Export API key as environment variable
    export OVM_API_KEY="${inputs.api_key}"
    
    # Install Overmind CLI
    REPO="overmindtech/cli"
    OS=$(uname -s)
    ARCH=$(uname -m)
    
    case "${ARCH}" in
        x86_64) ARCH="x86_64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        i386|i686) ARCH="i386" ;;
        *) echo "Unsupported architecture: ${ARCH}"; exit 1 ;;
    esac
    
    case "${OS}" in
        Linux|Darwin) ARCHIVE_EXT="tar.gz" ;;
        MINGW*|MSYS*|CYGWIN*) OS="Windows"; ARCHIVE_EXT="zip" ;;
        *) echo "Unsupported OS: ${OS}"; exit 1 ;;
    esac
    
    # Function to find a writable directory in PATH
    find_install_dir() {
        IFS=':'
        for dir in $PATH; do
            [ -z "$dir" ] && continue
            
            # Create directory if it doesn't exist (if parent is writable)
            if [ ! -d "$dir" ]; then
                mkdir -p "$dir" 2>/dev/null || continue
            fi
            
            # Check if directory is writable
            if [ -w "$dir" ]; then
                echo "$dir"
                unset IFS
                return 0
            fi
        done
        unset IFS
        return 1
    }
    
    INSTALL_DIR=$(find_install_dir)
    if [ -z "${INSTALL_DIR}" ]; then
        echo "Error: No writable directory found in PATH"
        echo "Current PATH: ${PATH}"
        exit 1
    fi
    
    echo "Installing to: ${INSTALL_DIR}"
    echo "Detecting latest release..."
    
    LATEST_VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    if [ -z "${LATEST_VERSION}" ]; then
        echo "Failed to fetch latest version"
        exit 1
    fi
    
    echo "Latest version: ${LATEST_VERSION}"
    VERSION_NUMBER=$(echo "${LATEST_VERSION}" | sed 's/^v//')
    FILENAME="overmind_cli_${VERSION_NUMBER}_${OS}_${ARCH}.${ARCHIVE_EXT}"
    DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${LATEST_VERSION}/${FILENAME}"
    
    echo "Downloading ${FILENAME}..."
    TMP_DIR=$(mktemp -d)
    trap "rm -rf ${TMP_DIR}" EXIT
    cd "${TMP_DIR}"
    
    curl -fsSL "${DOWNLOAD_URL}" -o archive
    
    if [ "${ARCHIVE_EXT}" = "tar.gz" ]; then
        tar -xzf archive
    else
        unzip -q archive
    fi
    
    BINARY=$(find . -maxdepth 1 -type f -executable -name "overmind*" ! -name "*.txt" ! -name "*.md" ! -name "LICENSE" | head -n 1)
    if [ -z "${BINARY}" ]; then
        echo "Error: Could not find binary in archive"
        ls -la
        exit 1
    fi
    
    cp "${BINARY}" "${INSTALL_DIR}/overmind"
    chmod +x "${INSTALL_DIR}/overmind"
    echo "âœ“ Overmind CLI ${LATEST_VERSION} installed to ${INSTALL_DIR}/overmind"
    
    # Verify installation
    "${INSTALL_DIR}/overmind" version 2>/dev/null || echo "Installation complete"
    
    # Construct the env0 deployment URL for the ticket-link
    ticket_link="https://app.env0.com/p/${ENV0_PROJECT_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}?organizationId=${ENV0_ORGANIZATION_ID}"
    
    # Build description from env0 deployment info
    description="Env0 Deployment: ${ENV0_PROJECT_NAME} - ${ENV0_ENVIRONMENT_NAME} (${ENV0_DEPLOYMENT_TYPE})"
    if [ -n "${ENV0_DEPLOYER_NAME}" ]; then
        description="${description} by ${ENV0_DEPLOYER_NAME}"
    fi
    
    # Build title from env0 deployment info
    title="${ENV0_PROJECT_NAME} - ${ENV0_ENVIRONMENT_NAME}"
    if [ -n "${ENV0_TEMPLATE_NAME}" ]; then
        title="${ENV0_TEMPLATE_NAME} (${ENV0_ENVIRONMENT_NAME})"
    fi
    
    # Execute the appropriate action based on input
    case "${inputs.action}" in
        submit-plan)
            if [ -z "${ENV0_TF_PLAN_JSON}" ]; then
                echo "Error: ENV0_TF_PLAN_JSON environment variable is not set"
                exit 1
            fi
            echo "Submitting plan to Overmind..."
            
            # Generate code changes diff if in a git repository
            DIFF_FILE=""
            if [ -d "${ENV0_TEMPLATE_DIR}/.git" ] && [ -n "${ENV0_TEMPLATE_REVISION}" ]; then
                cd "${ENV0_TEMPLATE_DIR}"
                if git rev-parse HEAD~1 >/dev/null 2>&1; then
                    DIFF_FILE=$(mktemp)
                    git diff HEAD~1 HEAD > "${DIFF_FILE}" 2>/dev/null || true
                    if [ ! -s "${DIFF_FILE}" ]; then
                        rm -f "${DIFF_FILE}"
                        DIFF_FILE=""
                    fi
                fi
            fi
            
            # Find terraform plan output file if it exists
            PLAN_OUTPUT=""
            if [ -f "${ENV0_TEMPLATE_DIR}/.tf-plan-output" ]; then
                PLAN_OUTPUT="${ENV0_TEMPLATE_DIR}/.tf-plan-output"
            elif [ -f "${ENV0_ROOT_DIR}/.tf-plan-output" ]; then
                PLAN_OUTPUT="${ENV0_ROOT_DIR}/.tf-plan-output"
            fi
            
            # Determine owner (prefer name over email)
            OWNER=""
            if [ -n "${ENV0_DEPLOYER_NAME}" ]; then
                OWNER="${ENV0_DEPLOYER_NAME}"
            elif [ -n "${ENV0_DEPLOYER_EMAIL}" ]; then
                OWNER="${ENV0_DEPLOYER_EMAIL}"
            fi
            
            # Build submit-plan command with all available information
            set -- "${INSTALL_DIR}/overmind" changes submit-plan \
                "${ENV0_TF_PLAN_JSON}" \
                --title "${title}" \
                --description "${description}" \
                --ticket-link "${ticket_link}"
            if [ -n "${inputs.app}" ]; then
                set -- "$@" --app "${inputs.app}"
            fi
            if [ -n "${ENV0_TEMPLATE_REPOSITORY}" ]; then
                set -- "$@" --repo "${ENV0_TEMPLATE_REPOSITORY}"
            fi
            if [ -n "${OWNER}" ]; then
                set -- "$@" --owner "${OWNER}"
            fi
            if [ -n "${inputs.tags}" ]; then
                set -- "$@" --tags "${inputs.tags}"
            fi
            if [ -n "${PLAN_OUTPUT}" ]; then
                set -- "$@" --terraform-plan-output "${PLAN_OUTPUT}"
            fi
            if [ -n "${DIFF_FILE}" ]; then
                set -- "$@" --code-changes-diff "${DIFF_FILE}"
            fi
            "$@"
            
            # Clean up diff file if created
            if [ -n "${DIFF_FILE}" ] && [ -f "${DIFF_FILE}" ]; then
                rm -f "${DIFF_FILE}"
            fi
            ;;
        start-change)
            echo "Starting change in Overmind..."
            "${INSTALL_DIR}/overmind" changes start-change \
                --ticket-link "${ticket_link}"
            ;;
        end-change)
            echo "Ending change in Overmind..."
            "${INSTALL_DIR}/overmind" changes end-change \
                --ticket-link "${ticket_link}"
            ;;
        *)
            echo "Error: Invalid action '${inputs.action}'. Must be one of: submit-plan, start-change, end-change"
            exit 1
            ;;
    esac

